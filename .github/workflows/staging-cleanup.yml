name: Cleanup Staging Environments

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      max_age_days:
        description: 'Remove staging environments older than X days'
        required: false
        type: string
        default: '7'
      dry_run:
        description: 'Dry run (show what would be removed without removing)'
        required: false
        type: boolean
        default: false
  pull_request:
    types: [closed]

jobs:
  cleanup-on-pr-close:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Get PR branch name
        id: branch
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "name=${BRANCH}" >> $GITHUB_OUTPUT

          # Calculate port for this branch (same logic as deploy)
          if [[ "${BRANCH}" != "develop" ]]; then
            HASH=$(echo -n "${BRANCH}" | md5sum | cut -c1-8)
            PORT_OFFSET=$((0x${HASH} % 99))
            PORT=$((9001 + ${PORT_OFFSET}))
            SAFE_BRANCH=$(echo "${BRANCH}" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]')
            CONTAINER_NAME="staging-${SAFE_BRANCH}"
          else
            # Don't remove develop staging
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "port=${PORT}" >> $GITHUB_OUTPUT
          echo "container_name=${CONTAINER_NAME}" >> $GITHUB_OUTPUT

      - name: Remove staging environment
        if: steps.branch.outputs.skip != 'true'
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.STAGING_HOST || secrets.DEPLOY_HOST }}
          username: ${{ secrets.STAGING_USER || secrets.DEPLOY_USER }}
          key: ${{ secrets.STAGING_KEY || secrets.DEPLOY_KEY }}
          port: ${{ secrets.STAGING_PORT || secrets.DEPLOY_PORT || '22' }}
          script: |
            CONTAINER_NAME="${{ steps.branch.outputs.container_name }}"
            PORT="${{ steps.branch.outputs.port }}"
            DEPLOY_DIR="$HOME/staging-deployments/${CONTAINER_NAME}"

            echo "üßπ Cleaning up staging for closed PR"
            echo "üì¶ Container: ${CONTAINER_NAME}"
            echo "üîå Port: ${PORT}"

            # Remove Docker Compose deployment if exists
            if [[ -d "${DEPLOY_DIR}" ]]; then
              cd "${DEPLOY_DIR}"
              if [[ -f docker-compose.yml ]]; then
                echo "Stopping Docker Compose services..."
                docker compose down --volumes --remove-orphans || true
              fi
              cd ~
              rm -rf "${DEPLOY_DIR}"
              echo "‚úÖ Removed deployment directory: ${DEPLOY_DIR}"
            else
              echo "‚ÑπÔ∏è Deployment directory not found: ${DEPLOY_DIR}"
            fi

            # Remove port assignment tracking
            rm -f ~/staging-ports/port-${PORT}.txt

            # Clean up related images
            docker images --format "{{.Repository}}:{{.Tag}}" | \
              grep "staging-${{ steps.branch.outputs.name }}" | \
              xargs -r docker rmi || true

      - name: Comment on PR
        if: steps.branch.outputs.skip != 'true'
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `üßπ **Staging environment has been removed**\n\nThe staging environment for this PR has been cleaned up after the PR was closed.`
            });

  scheduled-cleanup:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Clean up old staging environments
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.STAGING_HOST || secrets.DEPLOY_HOST }}
          username: ${{ secrets.STAGING_USER || secrets.DEPLOY_USER }}
          key: ${{ secrets.STAGING_KEY || secrets.DEPLOY_KEY }}
          port: ${{ secrets.STAGING_PORT || secrets.DEPLOY_PORT || '22' }}
          script: |
            set -e

            MAX_AGE_DAYS="${{ github.event.inputs.max_age_days || '7' }}"
            DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"

            echo "üßπ Staging Environment Cleanup"
            echo "üìÖ Removing environments older than ${MAX_AGE_DAYS} days"
            if [[ "${DRY_RUN}" == "true" ]]; then
              echo "‚ö†Ô∏è  DRY RUN MODE - No actual removals will be performed"
            fi

            # Find staging deployments older than MAX_AGE_DAYS
            CUTOFF_DATE=$(date -d "${MAX_AGE_DAYS} days ago" +%s)

            # Check staging deployment directories
            if [[ -d "$HOME/staging-deployments" ]]; then
              for DEPLOY_DIR in $HOME/staging-deployments/*/; do
                if [[ ! -d "${DEPLOY_DIR}" ]]; then
                  continue
                fi

                CONTAINER_NAME=$(basename "${DEPLOY_DIR}")

                # Skip if no .env file
                if [[ ! -f "${DEPLOY_DIR}.env" ]]; then
                  echo "‚ö†Ô∏è  Skipping ${CONTAINER_NAME} - no .env file"
                  continue
                fi

                # Extract deployment info from .env file
                BRANCH_NAME=$(grep "^BRANCH_NAME=" "${DEPLOY_DIR}.env" 2>/dev/null | cut -d'=' -f2)
                DEPLOYED_AT=$(grep "^DEPLOYED_AT=" "${DEPLOY_DIR}.env" 2>/dev/null | cut -d'=' -f2)
                PORT=$(grep "^PORT=" "${DEPLOY_DIR}.env" 2>/dev/null | cut -d'=' -f2)

                # Skip if no deployment date
                if [[ -z "${DEPLOYED_AT}" ]]; then
                  echo "‚ö†Ô∏è  Skipping ${CONTAINER_NAME} - no deployment date"
                  continue
                fi

                # Skip the main staging environment (develop branch)
                if [[ "${BRANCH_NAME}" == "develop" ]]; then
                  echo "‚ÑπÔ∏è  Keeping main staging: ${CONTAINER_NAME}"
                  continue
                fi

                # Convert deployed date to timestamp
                DEPLOYED_TIMESTAMP=$(date -d "${DEPLOYED_AT}" +%s 2>/dev/null || echo "0")

                # Check if deployment is old enough to remove
                if [[ ${DEPLOYED_TIMESTAMP} -lt ${CUTOFF_DATE} && ${DEPLOYED_TIMESTAMP} -gt 0 ]]; then
                  echo "üóëÔ∏è  Found old deployment: ${CONTAINER_NAME} (branch: ${BRANCH_NAME}, deployed: ${DEPLOYED_AT})"

                  if [[ "${DRY_RUN}" != "true" ]]; then
                    cd "${DEPLOY_DIR}"
                    if [[ -f docker-compose.yml ]]; then
                      docker compose down --volumes --remove-orphans || true
                    fi
                    cd ~
                    rm -rf "${DEPLOY_DIR}"

                    # Remove port tracking file
                    if [[ -n "${PORT}" ]]; then
                      rm -f ~/staging-ports/port-${PORT}.txt
                    fi

                    echo "‚úÖ Removed: ${CONTAINER_NAME}"
                  else
                    echo "  [DRY RUN] Would remove: ${CONTAINER_NAME}"
                  fi
                else
                  echo "‚úÖ Keeping recent: ${CONTAINER_NAME} (deployed: ${DEPLOYED_AT})"
                fi
              done
            else
              echo "‚ÑπÔ∏è  No staging deployments directory found"
            fi

            # Clean up unused staging images
            echo ""
            echo "üñºÔ∏è  Cleaning up unused staging images..."
            if [[ "${DRY_RUN}" != "true" ]]; then
              # Remove staging images not used by any container
              docker images --format "{{.Repository}}:{{.Tag}}\t{{.ID}}" | \
                grep "staging-" | \
                while read repo_tag image_id; do
                  if ! docker ps -a --format "{{.Image}}" | grep -q "${repo_tag}"; then
                    echo "Removing unused image: ${repo_tag}"
                    docker rmi ${image_id} || true
                  fi
                done

              # General cleanup (use hours instead of days for the filter)
              HOURS=$((MAX_AGE_DAYS * 24))
              docker system prune -af --filter "until=${HOURS}h" || true
              echo "‚úÖ Image cleanup complete"
            else
              echo "[DRY RUN] Would clean up unused images"
            fi

            # Show current staging deployments
            echo ""
            echo "üìä Current Staging Deployments:"
            if [[ -d "$HOME/staging-deployments" ]]; then
              for DEPLOY_DIR in $HOME/staging-deployments/*/; do
                if [[ -d "${DEPLOY_DIR}" && -f "${DEPLOY_DIR}.env" ]]; then
                  CONTAINER_NAME=$(basename "${DEPLOY_DIR}")
                  BRANCH_NAME=$(grep "^BRANCH_NAME=" "${DEPLOY_DIR}.env" 2>/dev/null | cut -d'=' -f2)
                  PORT=$(grep "^PORT=" "${DEPLOY_DIR}.env" 2>/dev/null | cut -d'=' -f2)
                  DEPLOYED_AT=$(grep "^DEPLOYED_AT=" "${DEPLOY_DIR}.env" 2>/dev/null | cut -d'=' -f2)

                  cd "${DEPLOY_DIR}"
                  STATUS="Not running"
                  if docker compose ps 2>/dev/null | grep -q "${CONTAINER_NAME}"; then
                    if docker compose ps 2>/dev/null | grep -q "healthy"; then
                      STATUS="‚úÖ Healthy"
                    else
                      STATUS="‚ö†Ô∏è  Running"
                    fi
                  fi

                  echo "  - ${CONTAINER_NAME} (${BRANCH_NAME}) on port ${PORT} - ${STATUS} - Deployed: ${DEPLOYED_AT}"
                fi
              done
            else
              echo "  No staging deployments found"
            fi